<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v13.0.0: USB audio class module</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v13.0.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<!--<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>-->
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s132","s140","s212","s332"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lib_usbd_class_audio.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">USB audio class module </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><div class="whichnRF nRF52840"><span>This information applies to the <b>nRF52840 SoC</b> only.</span></div><p>This module allows to create and handle USB audio class instances. For detailed information on the USB audio class, refer to these specification documents:</p>
<ul>
<li><a href="http://www.usb.org/developers/docs/devclass_docs/audio10.pdf" target="_blank">Universal Serial Bus Device Class Definition for Audio Devices</a></li>
</ul>
<ul>
<li><a href="http://www.usb.org/developers/docs/devclass_docs/frmts10.pdf" target="_blank">Universal Serial Bus Device Class Definition for Audio Data Formats</a></li>
</ul>
<ul>
<li><a href="http://www.usb.org/developers/docs/devclass_docs/termt10.pdf" target="_blank">Universal Serial Bus Device Class Definition for Terminal Types</a></li>
</ul>
<h1><a class="anchor" id="define_audio_descriptor"></a>
Defining audio class descriptors</h1>
<p>A typical audio class has one control interface and one streaming interface. Before you can declare a class instance, you must first properly define the audio class descriptors. These must be defined as a raw uint8_t array.</p>
<p>Example 1: Layout of headphone descriptors in a raw array:</p>
<div class="fragment"><div class="line"> AUDIO_CONTROL_INTERFACE</div>
<div class="line"> AUDIO_CONTROL_HEADER</div>
<div class="line">    INPUT_TERMINAL</div>
<div class="line">    FEATURE_UNIT</div>
<div class="line">    OUTPUT_TERMINAL</div>
<div class="line">AUDIO_STREAMING_INTERFACE_ALTERNATE0</div>
<div class="line">AUDIO_STREAMING_INTERFACE_ALTERNATE1</div>
<div class="line">    AS_FORMAT_III</div>
<div class="line">    EP_GENERAL</div>
<div class="line">    ISO_EP_OUT</div>
</div><!-- fragment --><p>Example 2: Layout of microphone descriptors in a raw array:</p>
<div class="fragment"><div class="line">AUDIO_CONTROL_INTERFACE</div>
<div class="line">AUDIO_CONTROL_HEADER</div>
<div class="line">   INPUT_TERMINAL</div>
<div class="line">   FEATURE_UNIT</div>
<div class="line">   OUTPUT_TERMINAL</div>
<div class="line">AUDIO_STREAMING_INTERFACE_ALTERNATE0</div>
<div class="line">AUDIO_STREAMING_INTERFACE_ALTERNATE1</div>
<div class="line">   AS_FORMAT_III</div>
<div class="line">   EP_GENERAL</div>
<div class="line">   ISO_EP_IN </div>
</div><!-- fragment --><p>The difference between headphones and microphone descriptors is in the direction of the isochronous endpoint descriptor. Microphone has the IN direction defined (from the USB device to the host). For headphones, the isochronous endpoint direction is set to OUT (from the host to the USB device). Both of these classes have two audio streaming descriptors:</p>
<ul>
<li>Streaming interface, alternate setting 0, is selected by the host when no isochronous transfers are required.</li>
<li>Streaming interface, alternate setting 1, has the following three descriptors defined:<ul>
<li>Audio streaming format descriptor (I, II, or III)</li>
<li>Audio streaming endpoint descriptor</li>
<li>Standard endpoint descriptor</li>
</ul>
</li>
</ul>
<p>Example: Raw uint8_t descriptors for an audio class (Headphones: 2 channels, Fs = 48KHz, Format 16bit PCM): </p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">const</span> uint8_t m_hp_audio_class_descriptors[] = {</div>
<div class="line">        <span class="comment">/* Audio control interface descriptor: 0</span></div>
<div class="line"><span class="comment">           + descriptors defined by AUDIO_CONTROL_DSC_LIST */</span></div>
<div class="line">        <a class="code" href="group__app__usbd__audio__dsc.html#gaef921b00fa723285c1fa3ef13df4cfd5" title="Macro to configure Audio Class control descriptor.">APP_USBD_AUDIO_CONTROL_DSC</a>(0, HP_AUDIO_CONTROL_DSC_LIST(), (1))</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Audio streaming interface descriptor: 1, setting: 0 */</span></div>
<div class="line">        <a class="code" href="group__app__usbd__audio__dsc.html#gabfdd5d08f7b89c37ca36e37ec14f5641" title="Macro to configure Audio Class streaming descriptor.">APP_USBD_AUDIO_STREAMING_DSC</a>(1, 0, 0)</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Audio streaming interface descriptor: 1, setting: 1 */</span></div>
<div class="line">        <a class="code" href="group__app__usbd__audio__dsc.html#gabfdd5d08f7b89c37ca36e37ec14f5641" title="Macro to configure Audio Class streaming descriptor.">APP_USBD_AUDIO_STREAMING_DSC</a>(1, 1, 1)</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Audio class-specific interface descriptor */</span></div>
<div class="line">        <a class="code" href="group__app__usbd__audio__dsc.html#gaedc8dc67a496d0324831613a44a43d0a" title="Initializer of app_usbd_audio_as_iface_desc_t.">APP_USBD_AUDIO_AS_IFACE_DSC</a>(1, 0, <a class="code" href="group__app__usbd__audio__types.html#gga3edebfb6ad8b81440c0e4048f79fb16ba172bf2e3ab55a8f991162175b9a7c9b0">APP_USBD_AUDIO_AS_IFACE_FORMAT_PCM</a>)</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Audio class-specific format I descriptor */</span></div>
<div class="line">        <a class="code" href="group__app__usbd__audio__dsc.html#gad2fe58576e7688a63d28aaed9c9c1d69" title="Initializer of app_usbd_audio_as_format_type_three_desc_t.">APP_USBD_AUDIO_AS_FORMAT_III_DSC</a>(2, 2, 16, 1, <a class="code" href="group__app__usbd__descriptor.html#ga62bfea6b42af7802eef498fddd3f44a2" title="Helper macro for translating unsigned 24 bit value to 3 byte raw descriptor.">APP_USBD_U24_TO_RAW_DSC</a>(48000))</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Audio class-specific endpoint general descriptor */</span></div>
<div class="line">        <a class="code" href="group__app__usbd__audio__dsc.html#gaebed84f76d3cc25c2f5ddaca1a5e44f7" title="Initializer of app_usbd_audio_as_endpoint_desc_t.">APP_USBD_AUDIO_EP_GENERAL_DSC</a>(0x00, 0, 0)</div>
<div class="line"></div>
<div class="line">        <span class="comment">/* Standard ISO endpoint descriptor */</span></div>
<div class="line">        <a class="code" href="group__app__usbd__audio__dsc.html#gaf2277d619252fb93628d26ed1e1896e0" title="Simplified version of APP_USBD_AUDIO_ISO_EP_DSC for ISO OUT endpoint.">APP_USBD_AUDIO_ISO_EP_OUT_DSC</a>(192)</div>
<div class="line">};</div>
</div><!-- fragment --><h1><a class="anchor" id="define_audio_class"></a>
Defining audio classes</h1>
<p>When all descriptors are correctly defined, you can define the audio class: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define HP_INTERFACES_CONFIG() APP_USBD_AUDIO_CONFIG_OUT(0, 1)</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><a class="code" href="group__app__usbd__audio.html#gad7c35c036a39ad63cced42af612c561f" title="Global definition of app_usbd_audio_t class instance.">APP_USBD_AUDIO_GLOBAL_DEF</a>(m_app_audio_headphone,</div>
<div class="line">                          HP_INTERFACES_CONFIG(),</div>
<div class="line">                          hp_audio_user_ev_handler,</div>
<div class="line">                          m_hp_audio_class_descriptors</div>
<div class="line">);</div>
</div><!-- fragment --><p>You can pass an event handler function to the class instance definition. The following is an example of a correct audio class user event handler prototype:</p>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> audio_user_ev_handler(<a class="code" href="structapp__usbd__class__inst__t.html">app_usbd_class_inst_t</a> <span class="keyword">const</span> * p_inst,</div>
<div class="line">                           <a class="code" href="group__app__usbd__audio.html#gaf4f4d332db9ddb57e064709ca553fd39" title="Events passed to user event handler.">app_usbd_audio_user_event_t</a>   event);</div>
</div><!-- fragment --><h1><a class="anchor" id="register_audio_class"></a>
Registering an audio class to the USBD library</h1>
<p>After the function is defined, you must register the new class to the USBD library:</p>
<div class="fragment"><div class="line">ret = <a class="code" href="group__app__usbd.html#ga5b0ac80bcb0f2440027bf9173981c69f" title="USB library initialization.">app_usbd_init</a>();</div>
<div class="line">ASSERT(ret == NRF_SUCCESS);</div>
<div class="line"></div>
<div class="line"><a class="code" href="structapp__usbd__class__inst__t.html">app_usbd_class_inst_t</a> <span class="keyword">const</span> * class_inst_hp = <a class="code" href="group__app__usbd__audio.html#ga48192ddd5d28d75fa33f4daa05f897dc">app_usbd_audio_class_inst_get</a>(&amp;m_app_audio_headphone);</div>
<div class="line">ret = app_usbd_controller_class_append(class_inst_hp);</div>
<div class="line">ASSERT(ret == NRF_SUCCESS);</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__app__usbd.html#gae6b56c2e6aa8074c9fa5bcf61cc608dd" title="Enable USBD.">app_usbd_enable</a>();</div>
<div class="line"><a class="code" href="group__app__usbd.html#ga13088881a90703a337690c3eb4c930ee" title="Start USB to work.">app_usbd_start</a>();</div>
</div><!-- fragment --><p>Events defined by <a class="el" href="group__app__usbd__audio.html#gaf4f4d332db9ddb57e064709ca553fd39">app_usbd_audio_user_event_t</a> are passed to the user event handler. Requests defined for the audio class trigger the <a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250a070a9c9415d51778ffff4b9f322fc873">APP_USBD_AUDIO_USER_EVT_CLASS_REQ</a> event. Access to the class request data is obtained by the <a class="el" href="group__app__usbd__audio.html#ga99ca99c18f0452622626af93b9bea3bb">app_usbd_audio_class_request_get</a> function. Isochronous transfers trigger two types of events:</p>
<ul>
<li><a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250ae422ac2b2b368a07dafa2eefe57633cd">APP_USBD_AUDIO_USER_EVT_RX_DONE</a> for OUT endpoints.</li>
<li><a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250a9fb5cfd200085bccdec973e6a8528dd9">APP_USBD_AUDIO_USER_EVT_TX_DONE</a> for IN endpoints.</li>
</ul>
<p>The library client must set up buffers for isochronous transfers:</p>
<ul>
<li><a class="el" href="group__app__usbd__audio.html#ga4fc19618a8e5a19faef844dce81d3912">app_usbd_audio_class_tx_buf_set</a>, when an IN endpoint is defined in the audio descriptors.</li>
<li><a class="el" href="group__app__usbd__audio.html#gaf759837f895d430407efce4eb8fd9ede">app_usbd_audio_class_rx_buf_set</a>, when an OUT endpoint is defined in the audio descriptors.</li>
</ul>
<p>Size of these transfer buffers must be the same as the endpoint size defined in raw descriptors. Example: After registering the headphones example presented above, the following buffer is set up: </p>
<div class="fragment"><div class="line"><span class="keyword">static</span> int16_t m_rx_buffer[2 * 48];</div>
<div class="line"></div>
<div class="line">...</div>
<div class="line"></div>
<div class="line">app_usbd_audio_class_rx_buf_set(p_inst, m_rx_buffer, <span class="keyword">sizeof</span>(m_rx_buffer));</div>
</div><!-- fragment --><p>Isochronous transfer buffer can be safely switched (or modified) only on the <a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250ae422ac2b2b368a07dafa2eefe57633cd">APP_USBD_AUDIO_USER_EVT_RX_DONE</a> or <a class="el" href="group__app__usbd__audio.html#ggaae39410102fdd20b011690d827e48250ae422ac2b2b368a07dafa2eefe57633cd">APP_USBD_AUDIO_USER_EVT_RX_DONE</a> events. Every isochronous transfer is synchronized with the Start of Frame event (SOF) and it is fired automatically when the transfer buffer is configured. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Fri Mar 10 2017" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
