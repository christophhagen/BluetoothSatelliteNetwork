<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v13.0.0: Experimental: Flash Storage</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v13.0.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<!--<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>-->
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s132","s140","s212","s332"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lib_fstorage.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Experimental: Flash Storage </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Flash Storage (or fstorage for short) is a module for storing and erasing data in persistent flash storage. The module serves as a wrapper around the SoftDevice flash API. It accepts requests to store data or erase data pages and queues these requests up for asynchronous handling. The application is notified of the operation results through callbacks to registered event handlers.</p>
<p>Fstorage automatically splits up large writes and erases into smaller operations, thus enabling the SoftDevice to handle these requests between radio operations. Failed flash operations that are not accepted or not scheduled by the SoftDevice are retried.</p>
<p><a class="el" href="lib_fds.html">Experimental: Flash Data Storage</a> internally uses fstorage. The module can be used directly as well.</p>
<h1><a class="anchor" id="lib_fstorage_register"></a>
Registering usage</h1>
<p>The fstorage module can be used by different applications or different parts of an application at the same time (but not by multiple threads). Each user of flash storage must register with the module to request a number of pages of storage. A page in fstorage is a physical flash page, whose size depends on the chip. The module then grants access to these registered pages only; it is not possible to access the flash using addresses outside of the registered pages. All registered users use their own callback handler and receive updates for the pages that they are registered to use.</p>
<p>Usage registration is done at compile time through the use of <a class="el" href="lib_section_vars.html">Experimental: Section variables</a>. You must provide a function pointer to use for event callbacks, the number of pages to reserve, and a priority that specifies how space is assigned in flash. These parameters are specified at compile time and cannot be changed during run time.</p>
<dl class="section note"><dt>Note</dt><dd>If you update your application and want to retain existing application data, you must not change the priority or number of flash pages that are reserved for each module. To add pages for a new module, register them with a lower priority than the ones that are already in use.</dd></dl>
<p>To register usage in fstorage, call the <a class="el" href="group__fstorage.html#ga7b6937b812d30a80760ca578262a19b8">FS_REGISTER_CFG</a> macro that is defined in <code>fstorage.h</code>. Place code similar to the following example code in the application to create a section variable <code>fs_config</code> that contains the specified configuration for fstorage: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;fstorage.h&quot;</span></div>
<div class="line"></div>
<div class="line"><a class="code" href="group__fstorage.html#ga7b6937b812d30a80760ca578262a19b8" title="Macro for registering an fstorage configuration variable. Applications which use fstorage must regist...">FS_REGISTER_CFG</a>(<a class="code" href="structfs__config__t.html" title="fstorage application-specific configuration.">fs_config_t</a> fs_config) =</div>
<div class="line">{</div>
<div class="line">    .callback  = fs_evt_handler, <span class="comment">// Function for event callbacks.</span></div>
<div class="line">    .num_pages = NUM_PAGES,      <span class="comment">// Number of physical flash pages required.</span></div>
<div class="line">    .priority  = 0xFE            <span class="comment">// Priority for flash usage.</span></div>
<div class="line">};</div>
</div><!-- fragment --><h2><a class="anchor" id="lib_fstorage_register_evthandler"></a>
Event handler</h2>
<p>The following example code shows the signature of the event handler: </p>
<div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> fs_evt_handler(<a class="code" href="structfs__evt__t.html" title="An fstorage event.">fs_evt_t</a> <span class="keyword">const</span> * <span class="keyword">const</span> evt, <a class="code" href="group__fstorage.html#ga7d7c3e91fa4f4614eaf115069db12374" title="fstorage return values.">fs_ret_t</a> result)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">if</span> (result != FS_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// An error occurred.</span></div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="lib_fstorage_register_priority"></a>
Priority for flash usage</h2>
<p>For each module registration, you must specify the priority with which fstorage assigns flash space to the module. Possible values are 0 to 255, where 255 is reserved for usage by the <a class="el" href="lib_peer_manager.html">Peer Manager</a>. All configured priorities must be unique.</p>
<p>Flash storage assigns flash space with the highest memory address (right below the bootloader, if present) to the module with the highest priority. So if, for example, module 1 has low priority and needs one page and module 2 has high priority and needs two pages, fstorage assigns two pages starting with the highest memory address to module 2 and one page, starting after the two pages, to module 1.</p>
<h1><a class="anchor" id="lib_fstorage_init"></a>
Initializing</h1>
<p>The following code example shows how to initialize fstorage: </p>
<div class="fragment"><div class="line"><a class="code" href="group__fstorage.html#ga7d7c3e91fa4f4614eaf115069db12374" title="fstorage return values.">fs_ret_t</a> ret = <a class="code" href="group__fstorage.html#ga26dabfb4f9594822d7762803caa932d9" title="Function for initializing the module.">fs_init</a>();</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (ret != FS_SUCCESS)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// An error occurred.</span></div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="lib_fstorage_store"></a>
Storing and erasing data</h1>
<p>Flash storage queues requests for flash operations and interfaces with the SoftDevice to get timeslots for handling these operations in a timely manner. Large store requests are split up to better negotiate with the SoftDevice to get the wanted timeslots. The maximum number of words in one store request can be specified in the <a class="el" href="group__fstorage__config.html#ga622bd14fcc3353d8bccb6d8573573b72">FS_MAX_WRITE_SIZE_WORDS</a> define in <code>fstorage_config.h</code>. Requests to erase multiple pages are split up into individual page erases.</p>
<p>If the SoftDevice does not accept a request, fstorage repeats the queued operation until the SoftDevice accepts the request. If the SoftDevice accepts the request but fails to schedule the flash operation so that it times out (for example, because of high BLE activity), fstorage repeats the request for a configurable number of times. The maximum number of retries can be specified in the <a class="el" href="group__fstorage__config.html#gaff51d3269afe2181887fa38ae0e33e00">FS_OP_MAX_RETRIES</a> define in <code>fstorage_config.h</code>. The registered user is notified about success or failure by an event callback.</p>
<p>The following code example shows how to store data, assuming that <code>fs_config</code> is a section variable that holds the fstorage configuration: </p>
<div class="fragment"><div class="line"><span class="keyword">static</span> uint32_t data = 0xAAAAAAAA;</div>
<div class="line"></div>
<div class="line"><a class="code" href="group__fstorage.html#ga7d7c3e91fa4f4614eaf115069db12374" title="fstorage return values.">fs_ret_t</a> ret = <a class="code" href="group__fstorage.html#gaf94976860d509d5c8d28c6d3bbb9a059" title="Function for storing data in flash.">fs_store</a>(&amp;fs_config, fs_config.p_start_addr, &amp;data, 1);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (ret != FS_SUCCESS)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// An error occurred.</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>The following code example shows how to erase pages: </p>
<div class="fragment"><div class="line"><span class="preprocessor">#define PAGE_SIZE_WORDS 1024</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Retrieve the address of a page.</span></div>
<div class="line"><span class="keyword">static</span> uint32_t <span class="keyword">const</span> * address_of_page(uint16_t page_num)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> fs_config.p_start_addr + (page_num * PAGE_SIZE_WORDS);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><a class="code" href="group__fstorage.html#ga7d7c3e91fa4f4614eaf115069db12374" title="fstorage return values.">fs_ret_t</a> ret;</div>
<div class="line"></div>
<div class="line"><span class="comment">// Erase one page (page 0).</span></div>
<div class="line">ret = <a class="code" href="group__fstorage.html#ga0428a1e8a5988a9d031f67ce67ff8eb1" title="Function for erasing flash pages.">fs_erase</a>(&amp;fs_config, address_of_page(0), 1);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (ret != FS_SUCCESS)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// An error occurred.</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Erase two pages, starting from page 3.</span></div>
<div class="line">ret = <a class="code" href="group__fstorage.html#ga0428a1e8a5988a9d031f67ce67ff8eb1" title="Function for erasing flash pages.">fs_erase</a>(&amp;fs_config, address_of_page(3), 2);</div>
<div class="line"></div>
<div class="line"><span class="keywordflow">if</span> (ret != FS_SUCCESS)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// An error occurred.</span></div>
<div class="line">}</div>
</div><!-- fragment --><p>Success or failure of each operation is indicated through event callbacks. Therefore, checking the return value confirms only that the function was called successfully, but not whether the operation is actually carried out. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Fri Mar 10 2017" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
