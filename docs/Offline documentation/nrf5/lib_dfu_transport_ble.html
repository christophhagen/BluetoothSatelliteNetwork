<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.3.1"/>
<title>nRF5 SDK v13.0.0: BLE</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="extra_stylesheet_offline.css" rel="stylesheet" type="text/css"/>
<link href="nordic.css" rel="stylesheet" type="text/css" />
<link rel="Shortcut icon" href="./favicon.ico" type="image/x-icon" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0" width="100%" class="blank">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Nordic Semiconductor" src="nordic_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">nRF5 SDK
   &#160;<span id="projectnumber">v13.0.0</span>
   </div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
<table cellspacing="0" cellpadding="0" class="blank">
<tr>
<td class="doclinkintro">Choose documentation:</td>
<td class="doclinks" id="nrf5"><a href="../nrf5/index.html">nRF5 SDK</a></td>
<td class="doclinks" id="s132"><a href="../s132/index.html">S132 SoftDevice API</a></td>
<td class="doclinks" id="s140"><a href="../s140/index.html">S140 SoftDevice API</a></td>
<td class="doclinks" id="s212"><a href="../s212/index.html">S212 SoftDevice API</a></td>
<!--<td class="doclinks" id="s332"><a href="../s332/index.html">S332 SoftDevice API</a></td>-->
</tr>
</table>
<script>
var url=window.location.href.split("/").reverse()[1];
var validLinks= ["nrf5","s132","s140","s212","s332"];
var index;
for (index = 0; index < validLinks.length; ++index) {
   if ( url.indexOf(validLinks[index]) !== -1 ) {
      document.getElementById(validLinks[index]).setAttribute('class', 'doclinks docselected');
   };
};
</script>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.3.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('lib_dfu_transport_ble.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">BLE </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Secure Device Firmware Update (DFU) Service exposes necessary information to perform Device Firmware Updates on the device. This service is a proprietary service defined by Nordic Semiconductor to demonstrate a typical Device Firmware Update on an nRF5 device.</p>
<p>The UUID for the Secure DFU Service is 0xFE59. The service must be instantiated as a primary service.</p>
<p>The DFU Service does not depend on any other services. Support for the following GATT sub-procedures is mandatory for this service:</p>
<ul>
<li>Write Characteristic Value</li>
<li>Write Characteristic Descriptor</li>
<li>Read Characteristic Descriptor</li>
<li>Notification</li>
</ul>
<p>The DFU Service does not define any new error codes for the Attribute Protocol. Data exchange is in little endian (LSB first) order.</p>
<p>See <a class="el" href="group__nrf__ble__dfu.html">DFU BLE Service</a> for the API documentation.</p>
<h1><a class="anchor" id="lib_dfu_transport_ble_chars"></a>
Service characteristics</h1>
<p>The following characteristics are mandatory:</p>
<table class="doxtable">
<tr>
<th>Characteristic name </th><th>Required properties </th><th>Optional properties </th><th>UUID</th></tr>
<tr>
<td>DFU Control Point </td><td>Write, Notify </td><td></td><td>0x8EC90001-F315-4F60-9FB8-838830DAEA50 </td></tr>
<tr>
<td>DFU Packet </td><td>WriteWithoutResponse, Notify </td><td></td><td>0x8EC90002-F315-4F60-9FB8-838830DAEA50 </td></tr>
</table>
<p>The service does not impose any security requirements, which mean that encryption is not mandatory for any characteristics of the service. However, encryption should be used if available.</p>
<h1><a class="anchor" id="lib_dfu_transport_ble_control_point"></a>
DFU Control Point</h1>
<p>The UUID of the DFU Control Point characteristic is 0x0001.</p>
<p>The DFU Control Point characteristic is used to control the state of the DFU process. All DFU procedures are requested by writing to this characteristic. A response that marks the end of the procedure is received as a notification.</p>
<p>The following table shows control point procedure operation codes and the respective parameters and response values:</p>
<table class="doxtable">
<tr>
<th width="10%">Opcode </th><th width="15%">Procedure </th><th width="25%">Description </th><th width="25%">Parameters </th><th width="25%">Response value  </th></tr>
<tr>
<td>0x01 </td><td>Create </td><td>Creates an object with the given type and selects it. Removes an old object of the same type (if such an object exists). </td><td><p class="starttd">Type (uint8_t), Size (uint32)</p>
<p>Types:</p>
<ul>
<li>0x01 - Command object</li>
<li>0x02 - Data object (firmware)</li>
</ul>
<p class="endtd">Size:</p>
<ul>
<li>Object size in little endian </li>
</ul>
</td><td></td></tr>
<tr>
<td>0x02 </td><td>Set Packet Receipt Notification (PRN) value </td><td>Sets the number of packets to be sent before receiving a Packet Receipt Notification. The default is 0. </td><td>Value (uint16, little endian) </td><td></td></tr>
<tr>
<td>0x03 </td><td>Calculate checksum </td><td>Requests the checksum of the object that was sent (applicable only for data objects). The checksum is reset when executing the final data object. </td><td>None </td><td>Offset (uint32), CRC32 (uint32)  </td></tr>
<tr>
<td>0x04 </td><td>Execute </td><td>Executes the last object that was sent. </td><td>None </td><td></td></tr>
<tr>
<td>0x06 </td><td>Select </td><td>Selects the last object with the given type that was sent. </td><td><p class="starttd">Type (uint8_t)</p>
<p class="endtd">Types:</p>
<ul>
<li>0x01 - Command object</li>
<li>0x02 - Data object (firmware) </li>
</ul>
</td><td>Maximum size (uint32), offset (uint32), CRC32 (uint32)  </td></tr>
<tr>
<td>0x60 </td><td>Response Code </td><td></td><td>Request opcode, result code </td><td>For result code 0x0B: error code (uint8_t)  </td></tr>
</table>
<p>The following table lists the result codes that are sent as part of the response: </p>
<table class="doxtable">
<tr>
<th>Result code </th><th>Definition </th><th>Description</th></tr>
<tr>
<td>0x00 </td><td>Invalid code </td><td>The provided opcode was missing or malformed. </td></tr>
<tr>
<td>0x01 </td><td>Success </td><td>The operation completed successfully. </td></tr>
<tr>
<td>0x02 </td><td>Opcode not supported </td><td>The provided opcode was invalid. </td></tr>
<tr>
<td>0x03 </td><td>Invalid parameter </td><td>A parameter for the opcode was missing. </td></tr>
<tr>
<td>0x04 </td><td>Insufficient resources </td><td>There was not enough memory for the data object. </td></tr>
<tr>
<td>0x05 </td><td>Invalid object </td><td>The data object did not match the firmware and hardware requirements, the signature was missing, or parsing the command failed. </td></tr>
<tr>
<td>0x07 </td><td>Unsupported type </td><td>The provided object type was not valid for a Create or Read operation. </td></tr>
<tr>
<td>0x08 </td><td>Operation not permitted </td><td>The state of the DFU process did not allow this operation. </td></tr>
<tr>
<td>0x0A </td><td>Operation failed </td><td>The operation failed. </td></tr>
<tr>
<td>0x0B </td><td>Extended error </td><td>The DFU module has encountered the specified error. See <a class="el" href="group__nrf__dfu__rescodes.html#ga50daf693717ee90d08614d2a337e2361">nrf_dfu_ext_error_code_t</a> for the possible error codes. </td></tr>
</table>
<h1><a class="anchor" id="lib_dfu_transport_ble_dfu_packet"></a>
DFU Packet</h1>
<p>The UUID of the DFU Packet characteristic is 0x0002. This characteristic receives data for Device Firmware Updates as DFU packets.</p>
<p>The maximum size of each packet is 20 bytes. Packets must be in little endian (LSB first) order.</p>
<h1><a class="anchor" id="lib_dfu_transport_msc"></a>
Message sequence charts</h1>
<p>The following message sequence charts show the transfer of an init packet and a firmware image, respectively.</p>
<h2><a class="anchor" id="lib_dfu_transport_msc_init"></a>
Transfer of an init packet</h2>
<p>The DFU controller first checks if the init packet has already been transferred successfully. If not, the DFU controller checks if it has been transferred partially. If some data has been transferred already, the transfer is continued. Otherwise, the DFU controller sends a Create command to create a new data object and then transfers the init packet. When the init packet is available, the DFU controller issues an Execute command to initiate the validation of the init packet.</p>
<div align="center">
<img src="msc_inline_mscgraph_5.png" alt="msc_inline_mscgraph_5" border="0" usemap="#msc_inline_mscgraph_5.map"/>
<map name="msc_inline_mscgraph_5.map" id="msc_inline_mscgraph_5.map"></map>
</div>
<h2><a class="anchor" id="lib_dfu_transport_msc_data"></a>
Transfer of a firmware image</h2>
<p>A firmware image is split up into several data objects that are transferred consecutively. If the transfer of a data object fails (for example, because of a power loss), the transfer can be continued instead of restarted. Therefore, the DFU controller starts by selecting the last data object that was sent and checks if it is complete and valid. If it is, the controller issues an Execute command and then continues the transfer with the next data object. Otherwise, the DFU controller sends a Create command to create a new data object if required (thus if the transfer for this data object has not started yet or the received data is corrupted) and then transfers the next data object.</p>
<p>When all packets are transferred, the DFU controller issues an Execute command to trigger the actual firmware update.</p>
<p>The DFU controller is responsible for keeping track of the progress. The response to each Select command contains information about the maximum object size, the current offset, and the CRC. For example, if the image size is 10 kB and the maximum object size is 4 kB, 3 data objects must be transferred. If the returned offset is 6 kB, the DFU controller knows that the current object is the second object to transfer and that is has not been transferred completely.</p>
<div align="center">
<img src="msc_inline_mscgraph_6.png" alt="msc_inline_mscgraph_6" border="0" usemap="#msc_inline_mscgraph_6.map"/>
<map name="msc_inline_mscgraph_6.map" id="msc_inline_mscgraph_6.map"></map>
</div>
<h1><a class="anchor" id="lib_dfu_transport_reliability"></a>
Data reliability</h1>
<p>The BLE DFU Service is designed to handle serialized objects. However, transmitting and verifying serialized data is abstracted and not visible outside of the BLE transport layer.</p>
<p>To ensure that all data packets are received even though they are transmitted using WriteWithoutResponse, the DFU controller must perform a cyclic redundancy check (CRC) to validate the object before issuing an Execute command. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="topicfooter">
<a href="mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback" id="maillink">Documentation feedback</a> | <a href="https://devzone.nordicsemi.com/questions/" target="_blank">Developer Zone</a> | <a href="http://response.nordicsemi.com/subscribe-to-our-newsletters" target="_blank">Subscribe</a> | Updated <span id="date"/>
<script>
var date = new Date("Fri Mar 10 2017" + " UTC");
document.getElementById("date").innerHTML = date.toJSON().slice(0, 10);
var url=window.location.href.split("?")[0];
var filename=url.substring(url.lastIndexOf('/')+1);
document.getElementById("maillink").href = "mailto:docfeedback@nordicsemi.no?subject=Documentation%20feedback"+decodeURIComponent("%26")+"body=File%20name%3A%20"+encodeURIComponent(filename);
</script>
</div>
</body>
</html>
